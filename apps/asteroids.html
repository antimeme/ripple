<!DOCTYPE html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, user-scalable=no" />
<meta name="viewport" content="initial-scale=1, maximum-scale=1" />
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes" />
<title>Asteroids</title>
<style>
 html, body
 { position: absolute; padding: 0; margin: 0; overflow: hidden; }
 canvas { background: #222; color: #eee; }
</style>

<script src="ripple/polyfill.js"></script>
<script src="ripple/ripple.js"></script>
<script src="ripple/fascia.js"></script>
<script src="ripple/multivec.js"></script>
<script src="ripple/grid.js"></script>
<script>//<![CDATA[
 fascia.ready(function() {
     var size = 1000;
     var ship = {
         x: 0, y: 0, dx: 0, dy: 0,
         size: 30, direction: -Math.PI/2,
         left: false, right: false, thrust: false, brake: false,
         shots: [], lastShot: 0,
         draw: function(ctx) {
             ctx.save();
             ctx.translate(this.x, this.y);
             ctx.rotate(this.direction);
             ctx.scale(this.size/2, this.size/2);
             ctx.beginPath();
             ctx.moveTo(1, 0);
             ctx.lineTo(-1, 2/3);
             ctx.lineTo(-2/3, 0);
             ctx.lineTo(-1, -2/3);
             ctx.lineTo(1, 0);
             if (this.thrust) {
                 ctx.moveTo(-5/4, 2/3);
                 ctx.lineTo(-3/2, 0);
                 ctx.lineTo(-5/4, -2/3);
                 ctx.moveTo(-3/2, 2/3);
                 ctx.lineTo(-2, 0);
                 ctx.lineTo(-3/2, -2/3);
             }
             if (this.brake) {
                 ctx.moveTo(0.7, 0.7);   ctx.lineTo(0.5, 0.5);
                 ctx.moveTo(0.7, -0.7);  ctx.lineTo(0.5, -0.5);
                 ctx.moveTo(-1, -1); ctx.lineTo(-0.8, -0.8);
                 ctx.moveTo(-1, 1);  ctx.lineTo(-0.8, 0.8);
             }
             ctx.restore();
             this.shots.forEach(function(shot) {
                 ctx.moveTo(shot.x + this.size * 0.15, shot.y);
                 ctx.arc(shot.x, shot.y, this.size * 0.15,
                         0, 2 * Math.PI);
             }, this);
             ctx.stroke();
         },
         update: function(ms, camera) {
             if (this.left)
                 this.direction -= ms / 200;
             if (this.right)
                 this.direction += ms / 200;
             if (this.thrust)
                 this.dx += Math.cos(this.direction) * ms / 1000;
             if (this.thrust)
                 this.dy += Math.sin(this.direction) * ms / 1000;
             if (this.brake) {
                 this.dx *= 0.98;
                 this.dy *= 0.98;
             }

             // Movement with wrap around
             this.x += this.dx * ms;
             if (this.x - this.size > camera.width/2)
                 this.x = -camera.width/2;
             else if (this.x + this.size < -camera.width/2)
                 this.x = camera.width /2;
             this.y += this.dy * ms;
             if (this.y - this.size > camera.height/2)
                 this.y = -camera.height/2;
             else if (this.y + this.size < -camera.height/2)
                 this.y = camera.height/2;

             var activeShots = [];
             this.shots.forEach(function(shot) {
                 shot.duration += ms;
                 if (shot.duration < 2000) {
                     shot.x += shot.dx * ms;
                     shot.y += shot.dy * ms;
                     activeShots.push(shot);
                 }
             }, this);
             this.shots = activeShots;
         },
         shoot: function() {
             if (this.shots.length >= 8)
                 return;
             var shot = {
                 x: this.x, y: this.y, duration: 0,
                 dx: Math.cos(this.direction) + this.dx,
                 dy: Math.sin(this.direction) + this.dy
             }
             this.shots.push(shot);
             console.log("DEBUG-shot", "{", shot.dx, ",", shot.dy, "}");
             console.log("DEBUG-ship", "{", this.dx, ",", this.dy, "}");
         },
     };
     var createAsteroid = function(size, npoints) {
         var points = [];
         var place = Math.random() * Math.PI * 2;
         for (var ii = 0; ii < (npoints || 16); ++ii)
             points.push(1/2 + Math.random() / 2);
         return {
             x: Math.cos(place) * 1000,
             y: Math.sin(place) * 1000,
             speed: 30 / size,
             size: size,
             direction: Math.random() * Math.PI * 2,
             angle: Math.random() * Math.PI * 2,
             points: points,
             draw: function(ctx) {
                 ctx.save();
                 ctx.translate(this.x, this.y);
                 ctx.rotate(this.angle);
                 ctx.scale(this.size/2, this.size/2);
                 ctx.beginPath();
                 if (this.points && this.points.length > 0) {
                     var index = this.points.length - 1;
                     var point = this.points[index];
                     ctx.moveTo(
                         Math.cos(index * 2 * Math.PI /
                             this.points.length) * point,
                         Math.sin(index * 2 * Math.PI /
                             this.points.length) * point);
                     this.points.forEach(function(point, index) {
                         ctx.lineTo(
                             Math.cos(index * 2 * Math.PI /
                                 this.points.length) * point,
                             Math.sin(index * 2 * Math.PI /
                                 this.points.length) * point);
                     }, this);
                 }
                 ctx.restore();
                 ctx.stroke();
             },
             update: function(ms, camera) {
                 this.angle += ms * Math.PI / (this.size * 30);

                 this.x += ms * this.speed * Math.cos(
                     this.direction);
                 if (this.x - this.size > camera.width/2)
                     this.x = -camera.width/2;
                 else if (this.x + this.size < -camera.width/2)
                     this.x = camera.width/2;

                 this.y += ms * this.speed * Math.sin(
                     this.direction);
                 if (this.y - this.size > camera.height/2)
                     this.y = -camera.height/2;
                 else if (this.y + this.size < -camera.height/2)
                     this.y = camera.height/2;
             }
         };
     };
     var asteroids = [];
     for (var ii = 0; ii < 8; ++ii)
         asteroids.push(createAsteroid(size / 2));

     return {
         resize: function(camera) {
             size = Math.min(camera.width, camera.height);
             ship.size = size / 20;
             asteroids.forEach(function(asteroid) {
                 asteroid.size = size / 5;
             });
         },
         draw: function(ctx, camera, now, last) {
             ctx.lineCap = "round";
             ctx.lineWidth = size / 400;

             ship.draw(ctx);
             asteroids.forEach(function(asteroid) {
                 asteroid.draw(ctx);
             });
         },
         update: function(ms, camera) {
             ship.update(ms, camera);
             asteroids.forEach(function(asteroid) {
                 asteroid.update(ms, camera);
             });
         },
         keydown: function(event, camera) {
             if (event.keyCode === 37 || event.key === 'a') {
                 ship.left = true; ship.right = false;
	     } else if (event.keyCode === 38 || event.key === 'w')
                 ship.thrust = true;
	     else if (event.keyCode === 39 || event.key === 'd') {
                 ship.right = true; ship.left = false;
	     } else if (event.keyCode === 40 || event.key === 's')
                 ship.brake = true;
             else if (event.key = ' ' || event.key === "Enter")
                 ship.shoot();
         },
         keyup: function(event, camera) {
             if (event.keyCode === 37 || event.key === 'a')
                 ship.left = false;
	     else if (event.keyCode === 38 || event.key === 'w')
                 ship.thrust = false;
	     else if (event.keyCode === 39 || event.key === 'd')
                 ship.right = false;
	     else if (event.keyCode === 40 || event.key === 's')
                 ship.brake = false;
         },
         isActive: true
     };
 }); //]]></script>
