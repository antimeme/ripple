<!DOCTYPE html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, user-scalable=no" />
<meta name="viewport" content="initial-scale=1, maximum-scale=1" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<title>Streya Vanguard</title>
<style>
 html, body {
     padding: 0; margin: 0; overflow: hidden;
     position: relative; background: #888;
 }
 canvas { background: #eee; }
 .panel {
     position: absolute; border: 3px solid blue; background: #aaa;
     overflow-y: scroll;
 }
 .panel legend
 { border: 3px solid blue; background: #aaa; border-radius: 8px; }
 .recruit
 { border: 2px solid green; border-radius: 8px; float: left; }
 .recruit legend
 { border: 2px solid green; border-radius: 8px; }
 .recruit ul { padding: 0; }
 .recruit li { padding: 0; list-style-type: none; }
</style>
<script type="module">//<![CDATA[
 import Ripple from "../ripple/ripple.mjs";
 import Camera from "../ripple/camera.mjs";
 import Grid from "../ripple/grid.mjs";
 import Character from "./character.mjs";

 function createPanel(parent) {
     const result = document.createElement("fieldset");
     const contents = document.createElement("div");
     const legend = document.createElement("legend");
     const title = document.createTextNode("Panel");
     const closeBTN = document.createElement("button");
     closeBTN.appendChild(document.createTextNode("X"));
     closeBTN.addEventListener("click", event =>
         { result.style.display = "none"; });
     legend.appendChild(closeBTN);
     legend.appendChild(title);

     result.appendChild(legend);
     result.appendChild(contents);
     result.style.display = "none";
     result.classList.add("panel");
     parent.appendChild(result);

     return {
         element: result,
         contents: contents,
         setTitle: text => { title.data = text; },
         show: function() { this.element.style.display = "block"; },
         resize: function(width, height) {
             const size = Math.min(width, height);
             const getPixels = value => Math.round(value) + "px";
             this.element.style.top = getPixels(size * 0.05);
             this.element.style.left = getPixels(size * 0.05);
             this.element.style.bottom = getPixels(0.05 * size);
             this.element.style.right = getPixels(0.05 * size);
             this.element.style.borderRadius = getPixels(size * 0.05);
         }
     };
 }

 Ripple.preloadURLs("./setting.json", (loaded) => {
     const setting = loaded["./setting.json"];
     const screen = document.createElement("canvas");
     const camera = new Camera(320, 240).setScale(4);
     const grid = Grid.create({type: "square", radius: 1});
     let draw_id = 0;

     document.body.appendChild(screen);
     const panel = createPanel(document.body);

     function draw() {
         if (!screen.getContext)
             throw Error("canvas has no getContext");
         const ctx = screen.getContext("2d");
         camera.configureContext(ctx);
         ctx.lineWidth = camera.getRadius() / 4096;
         ctx.font = "bold 42px sans-serif";
         ctx.textAlign = "center";
         ctx.textBaseline = "middle";

         ctx.beginPath();
         grid.mapRectangle(
             camera.toWorld({x: 0, y: 0}),
             camera.toWorld({x: camera.width, y: camera.height}),
             node => { grid.drawNode(ctx, node); });
         ctx.strokeStyle = "#222";
         ctx.stroke();

         camera.restoreContext(ctx);
         draw_id = 0;
     }
     function redraw() {
         if (!draw_id)
             draw_id = requestAnimationFrame(draw);
         return false;
     }

     function getPoint(event, thing) {
         const bounds = event.target.getBoundingClientRect();
         if (!thing)
             thing = event;
         return {x: thing.clientX - bounds.x,
                 y: thing.clientY - bounds.y};
     }
     let drag = undefined;
     let selected = undefined;

     screen.addEventListener("dblclick", event => {
         panel.contents.innerHTML = "";
         [0, 1, 2, 3].forEach(index => {
             panel.contents.appendChild(
                 Character.createRecruit(setting)); });
         panel.setTitle("Recruits");
         panel.show();
     });

     screen.addEventListener("mousedown", event => {
         drag = grid.markCell(camera.toWorld(getPoint(event)));
         selected = drag;
         return redraw();
     });

     screen.addEventListener("mousemove", event => {
         if (!drag)
             return false;
         drag = camera.toWorld(getPoint(event));
         camera.pan({x: drag.x - selected.x,
                     y: drag.y - selected.y});
         return redraw();
     });

     screen.addEventListener("mouseup", event => {
         drag = undefined;
         return redraw();
     });

     screen.addEventListener("wheel", event => {
         camera.zoom((event.wheelDeltaY > 0) ? (5/4) : (4/5), 1, 20);
         event.preventDefault();
         return redraw();
     });

     window.addEventListener("resize", event => {
         screen.height = window.innerHeight || window.clientHeight;
         screen.width = window.innerWidth || window.clientWidth;
         camera.resize(screen.width, screen.height);
         panel.resize(screen.width, screen.height);
         
         return redraw();
     });
     window.dispatchEvent(new Event("resize"));

 }); //]]></script>
